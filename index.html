<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç—…ä¾‹ç ”ä¹ å¹³å° - æ•°æ®ä»ªè¡¨ç›˜</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

    <style>
        .kpi-card {
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            min-height: 400px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .section-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .section-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .section-header:hover {
            background-color: #f9fafb;
        }

        .section-content {
            padding: 24px;
        }

        .trend-up {
            color: #EF4444;
        }

        .trend-down {
            color: #10B981;
        }

        .trend-neutral {
            color: #6B7280;
        }

        .help-icon {
            cursor: help;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .help-icon:hover {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">AIç—…ä¾‹ç ”ä¹ å¹³å° - æ•°æ®ä»ªè¡¨ç›˜</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="data-time-range" class="text-sm text-gray-500"></span>
                    <!-- å¯¼å‡ºæŒ‰é’® -->
                    <div class="relative">
                        <button id="export-btn"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            <span>å¯¼å‡ºæ•°æ®</span>
                        </button>
                        <!-- å¯¼å‡ºæ ¼å¼ä¸‹æ‹‰èœå• -->
                        <div id="export-menu"
                            class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                            <div class="py-1">
                                <button onclick="exportData('csv')"
                                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    <span>å¯¼å‡ºä¸º CSV</span>
                                </button>
                                <button onclick="exportData('json')"
                                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2">
                                        </path>
                                    </svg>
                                    <span>å¯¼å‡ºä¸º JSON</span>
                                </button>
                                <button onclick="exportData('excel')"
                                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span>å¯¼å‡ºä¸º Excel</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button id="refresh-btn"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <span id="refresh-text">åŠ è½½ä¸­...</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- ç­›é€‰æ§åˆ¶é¢æ¿ -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">æ•°æ®ç­›é€‰</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- æ—¥æœŸèŒƒå›´é€‰æ‹© -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸèŒƒå›´</label>
                    <input type="text" id="date-range-picker"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´">
                </div>

                <!-- å¿«æ·æ—¥æœŸé€‰æ‹© -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¿«æ·é€‰æ‹©</label>
                    <select id="quick-date-select"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="7">æœ€è¿‘7å¤©</option>
                        <option value="14">æœ€è¿‘14å¤©</option>
                        <option value="30">æœ€è¿‘30å¤©</option>
                    </select>
                </div>

                <!-- ç”¨æˆ·ç±»å‹ç­›é€‰ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·ç±»å‹</label>
                    <select id="user-type-filter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">å…¨éƒ¨ç”¨æˆ·</option>
                        <option value="first">ä»…é¦–æ¬¡ç”¨æˆ·</option>
                        <option value="returning">ä»…å›è®¿ç”¨æˆ·</option>
                    </select>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex items-end space-x-2">
                    <button id="apply-filter-btn"
                        class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        åº”ç”¨ç­›é€‰
                    </button>
                    <button id="reset-filter-btn"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        é‡ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- åŠ è½½æç¤º -->
        <div id="loading-overlay"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 flex flex-col items-center">
                <div class="loading-spinner"></div>
                <p class="mt-4 text-gray-600">åŠ è½½æ•°æ®ä¸­...</p>
            </div>
        </div>

        <!-- KPI å…³é”®æŒ‡æ ‡å¡ç‰‡åŒº -->
        <!-- æ—¶é—´èŒƒå›´æŒ‡æ ‡ -->
        <div class="mb-4">
            <h3 class="text-sm font-medium text-gray-600 mb-3 px-1">æ—¶é—´èŒƒå›´æŒ‡æ ‡</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- æ´»è·ƒç”¨æˆ·æ•° -->
                <div class="kpi-card bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-sm font-medium text-gray-500">æ´»è·ƒç”¨æˆ·æ•°</h3>
                            <svg onclick="showMetricHelp('total-users')" class="w-4 h-4 text-gray-400 help-icon"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p id="kpi-total-users" class="text-4xl font-bold text-gray-900">-</p>
                            <p id="kpi-total-users-change" class="text-sm mt-1">-</p>
                        </div>
                        <div id="kpi-total-users-chart" style="width: 80px; height: 40px;"></div>
                    </div>
                </div>

                <!-- æ–°ç”¨æˆ·æ•° -->
                <div class="kpi-card bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-sm font-medium text-gray-500">æ–°ç”¨æˆ·æ•°</h3>
                            <svg onclick="showMetricHelp('first-users')" class="w-4 h-4 text-gray-400 help-icon"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p id="kpi-first-users" class="text-4xl font-bold text-gray-900">-</p>
                            <p id="kpi-first-users-change" class="text-sm mt-1">-</p>
                        </div>
                        <div id="kpi-first-users-chart" style="width: 80px; height: 40px;"></div>
                    </div>
                </div>

                <!-- å›è®¿ç”¨æˆ·æ•° -->
                <div class="kpi-card bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-sm font-medium text-gray-500">å›è®¿ç”¨æˆ·æ•°</h3>
                            <svg onclick="showMetricHelp('returning-users')" class="w-4 h-4 text-gray-400 help-icon"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3m9 14V5a2 2 0 00-2-2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p id="kpi-returning-users" class="text-4xl font-bold text-gray-900">-</p>
                            <p id="kpi-returning-users-change" class="text-sm mt-1">-</p>
                        </div>
                        <div id="kpi-returning-users-chart" style="width: 80px; height: 40px;"></div>
                    </div>
                </div>

                <!-- è¿›å…¥é—®è¯Šç‡ -->
                <div class="kpi-card bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-sm font-medium text-gray-500">è¿›å…¥é—®è¯Šç‡</h3>
                            <svg onclick="showMetricHelp('enter-rate')" class="w-4 h-4 text-gray-400 help-icon"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p id="kpi-enter-rate" class="text-4xl font-bold text-gray-900">-</p>
                            <p id="kpi-enter-rate-change" class="text-sm mt-1">-</p>
                        </div>
                        <div id="kpi-enter-rate-chart" style="width: 80px; height: 40px;"></div>
                    </div>
                </div>

                <!-- æ´»è·ƒç‡ -->
                <div class="kpi-card bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-sm font-medium text-gray-500">æ´»è·ƒç‡</h3>
                            <svg onclick="showMetricHelp('diagnosis-rate')" class="w-4 h-4 text-gray-400 help-icon"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p id="kpi-diagnosis-rate" class="text-4xl font-bold text-gray-900">-</p>
                            <p id="kpi-diagnosis-rate-change" class="text-sm mt-1">-</p>
                        </div>
                        <div id="kpi-diagnosis-rate-chart" style="width: 80px; height: 40px;"></div>
                    </div>
                </div>

                <!-- å®Œæˆç‡ -->
                <div class="kpi-card bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-sm font-medium text-gray-500">å®Œæˆç‡</h3>
                            <svg onclick="showMetricHelp('complete-rate')" class="w-4 h-4 text-gray-400 help-icon"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p id="kpi-complete-rate" class="text-4xl font-bold text-gray-900">-</p>
                            <p id="kpi-complete-rate-change" class="text-sm mt-1">-</p>
                        </div>
                        <div id="kpi-complete-rate-chart" style="width: 80px; height: 40px;"></div>
                    </div>
                </div>

                <!-- æ¬¡æ—¥ç•™å­˜ç‡ -->
                <div class="kpi-card bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-sm font-medium text-gray-500">æ¬¡æ—¥ç•™å­˜ç‡</h3>
                            <svg onclick="showMetricHelp('retention-rate')" class="w-4 h-4 text-gray-400 help-icon"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p id="kpi-retention-rate" class="text-4xl font-bold text-gray-900">-</p>
                            <p id="kpi-retention-rate-change" class="text-sm mt-1">-</p>
                        </div>
                        <div id="kpi-retention-rate-chart" style="width: 80px; height: 40px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç´¯è®¡ç»Ÿè®¡æŒ‡æ ‡ -->
        <div class="mb-6">
            <h3 class="text-sm font-medium text-gray-600 mb-3 px-1">ç´¯è®¡ç»Ÿè®¡æŒ‡æ ‡</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- å¹³å°ç´¯è®¡ç”¨æˆ· -->
                <div class="kpi-card bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <h3 class="text-sm font-medium text-gray-500">å¹³å°ç´¯è®¡ç”¨æˆ·</h3>
                            <svg onclick="showMetricHelp('cumulative-users')" class="w-4 h-4 text-gray-400 help-icon"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </div>
                        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p id="kpi-cumulative-users" class="text-4xl font-bold text-gray-900">-</p>
                            <p id="kpi-cumulative-users-change" class="text-sm mt-1">-</p>
                        </div>
                        <div id="kpi-cumulative-users-chart" style="width: 80px; height: 40px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è½¬åŒ–æ¼æ–—åˆ†æ -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="text-lg font-semibold text-gray-900">è½¬åŒ–æ¼æ–—åˆ†æ</h2>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div class="section-content">
                <div id="funnel-chart" class="chart-container"></div>
            </div>
        </div>

        <!-- ç”¨æˆ·è¶‹åŠ¿åˆ†æ -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="text-lg font-semibold text-gray-900">ç”¨æˆ·è¶‹åŠ¿åˆ†æ</h2>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div class="section-content">
                <div id="trend-chart" class="chart-container"></div>
            </div>
        </div>

        <!-- ç”¨æˆ·ç»“æ„åˆ†æ -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="text-lg font-semibold text-gray-900">ç”¨æˆ·ç»“æ„åˆ†æ</h2>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div class="section-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div id="user-type-chart" class="chart-container"></div>
                    <div id="department-chart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½ä½¿ç”¨åˆ†æ -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="text-lg font-semibold text-gray-900">åŠŸèƒ½ä½¿ç”¨åˆ†æ</h2>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div class="section-content">
                <div id="feature-usage-chart" class="chart-container"></div>
            </div>
        </div>

        <!-- ç”¨æˆ·åé¦ˆ -->
        <div class="section-card">
            <div class="section-header">
                <div class="flex items-center space-x-2">
                    <h2 class="text-lg font-semibold text-gray-900">ç”¨æˆ·åé¦ˆ</h2>
                    <span id="feedback-count" class="px-2 py-0.5 text-xs font-medium bg-orange-100 text-orange-600 rounded-full">0</span>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div class="section-content">
                <div id="feedback-list" class="space-y-3">
                    <p class="text-gray-500 text-sm">æš‚æ— åé¦ˆæ•°æ®</p>
                </div>
            </div>
        </div>

    </div>

    <!-- AIåŠ©æ‰‹èŠå¤©ç•Œé¢ -->
    <div id="ai-chat-container"
        class="hidden fixed bottom-20 right-6 w-96 max-h-[650px] bg-white rounded-lg shadow-2xl flex flex-col z-50 border border-gray-200">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div
            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-lg flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                    </path>
                </svg>
                <h3 class="font-semibold">AIæ•°æ®åŠ©æ‰‹</h3>
            </div>
            <button onclick="toggleChat()" class="hover:bg-blue-700 rounded p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>

        <!-- ä¾›åº”å•†å’Œæ¨¡å‹é…ç½® -->
        <div class="px-4 py-3 bg-blue-50 border-b border-blue-100">
            <!-- ä¾›åº”å•†é€‰æ‹© -->
            <div class="mb-2">
                <label for="ai-provider-select" class="text-xs text-gray-600 font-medium">AI ä¾›åº”å•†ï¼š</label>
                <select id="ai-provider-select"
                    class="w-full text-xs px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white mt-1"
                    onchange="updateProviderConfig()">
                    <optgroup label="é»˜è®¤é…ç½®">
                        <option value="cloudflare" selected>Cloudflare Workerï¼ˆé»˜è®¤-å·²é…ç½®ï¼‰</option>
                    </optgroup>
                    <optgroup label="å¸¸ç”¨ä¾›åº”å•†">
                        <option value="deepseek">DeepSeek</option>
                        <option value="kimi">Kimi (æœˆä¹‹æš—é¢)</option>
                        <option value="alibaba">é˜¿é‡Œç™¾ç‚¼</option>
                        <option value="siliconflow">ç¡…åŸºæµåŠ¨ (SiliconFlow)</option>
                    </optgroup>
                    <optgroup label="è‡ªå®šä¹‰">
                        <option value="custom">è‡ªå®šä¹‰ç«¯ç‚¹</option>
                    </optgroup>
                </select>
            </div>

            <!-- è‡ªå®šä¹‰ç«¯ç‚¹é…ç½®ï¼ˆé»˜è®¤éšè—ï¼‰ -->
            <div id="custom-endpoint-config" class="hidden mb-2 space-y-2">
                <div>
                    <label for="custom-endpoint-url" class="text-xs text-gray-600">API ç«¯ç‚¹ï¼š</label>
                    <input type="text" id="custom-endpoint-url"
                        placeholder="https://api.example.com/v1/chat/completions"
                        class="w-full text-xs px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 mt-1" />
                </div>
                <div>
                    <label for="custom-api-key" class="text-xs text-gray-600">API Keyï¼š</label>
                    <input type="password" id="custom-api-key" placeholder="sk-..."
                        class="w-full text-xs px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 mt-1" />
                </div>
            </div>

            <!-- æ¨¡å‹é€‰æ‹© -->
            <div class="flex items-center space-x-2">
                <label for="ai-model-select" class="text-xs text-gray-600 font-medium">æ¨¡å‹ï¼š</label>
                <select id="ai-model-select"
                    class="flex-1 text-xs px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 focus:border-blue-400 bg-white"
                    onchange="updateModelDisplay()">
                    <!-- æ¨¡å‹é€‰é¡¹å°†æ ¹æ®ä¾›åº”å•†åŠ¨æ€æ›´æ–° -->
                    <option value="Qwen/Qwen2.5-7B-Instruct">Qwen2.5-7Bï¼ˆé»˜è®¤-å¿«é€Ÿï¼‰</option>
                    <option value="Qwen/Qwen2.5-72B-Instruct">Qwen2.5-72Bï¼ˆå¼ºå¤§-å‡†ç¡®ï¼‰</option>
                    <option value="deepseek-ai/DeepSeek-V3">DeepSeek-V3ï¼ˆæœ€å¼º-æ¨ç†ï¼‰</option>
                    <option value="THUDM/glm-4-9b-chat">GLM-4-9Bï¼ˆä¸­æ–‡ä¼˜åŒ–ï¼‰</option>
                    <option value="meta-llama/Llama-3.3-70B-Instruct">Llama-3.3-70Bï¼ˆé€šç”¨ï¼‰</option>
                    <option value="alibaba/Qwen2.5-Coder-7B-Instruct">Qwen2.5-Coder-7Bï¼ˆä»£ç ï¼‰</option>
                </select>
            </div>
            <p id="model-description" class="text-xs text-gray-500 mt-1">å‡è¡¡é€Ÿåº¦å’Œè´¨é‡ï¼Œé€‚åˆæ—¥å¸¸æŸ¥è¯¢</p>
        </div>

        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
            <div class="flex items-start space-x-2">
                <div
                    class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-sm font-semibold flex-shrink-0">
                    AI</div>
                <div class="bg-white rounded-lg p-3 shadow-sm max-w-[80%]">
                    <p class="text-sm text-gray-700">ä½ å¥½ï¼æˆ‘æ˜¯æ•°æ®åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ åˆ†æå’ŒæŸ¥è¯¢ä»ªè¡¨ç›˜æ•°æ®ã€‚</p>
                    <p class="text-xs text-gray-500 mt-2">ğŸ’¡ å·²ä¸ºå›¢é˜Ÿç»Ÿä¸€é…ç½®ï¼Œå¯ç›´æ¥ä½¿ç”¨</p>
                    <p class="text-sm text-gray-700 mt-2">ä½ å¯ä»¥é—®æˆ‘ï¼š</p>
                    <ul class="text-sm text-gray-600 mt-1 space-y-1">
                        <li>â€¢ æœ€è¿‘7å¤©æœ‰å¤šå°‘ç”¨æˆ·ï¼Ÿ</li>
                        <li>â€¢ è¿›å…¥é—®è¯Šç‡æ˜¯å¤šå°‘ï¼Ÿ</li>
                        <li>â€¢ å“ªä¸ªç§‘å®¤æœ€å—æ¬¢è¿ï¼Ÿ</li>
                        <li>â€¢ ç”¨æˆ·æ´»è·ƒè¶‹åŠ¿å¦‚ä½•ï¼Ÿ</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="p-4 border-t border-gray-200 bg-white rounded-b-lg">
            <div class="flex space-x-2">
                <input type="text" id="chat-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                    onkeypress="if(event.key==='Enter') sendMessage()" />
                <button onclick="sendMessage()"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
            <div id="chat-loading" class="hidden mt-2 text-sm text-gray-500 flex items-center space-x-2">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
                <span>AIæ­£åœ¨æ€è€ƒä¸­...</span>
            </div>
        </div>
    </div>

    <!-- AIåŠ©æ‰‹æµ®åŠ¨æŒ‰é’® -->
    <button onclick="toggleChat()" id="ai-chat-btn"
        class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-110 flex items-center justify-center z-40">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
            </path>
        </svg>
    </button>

    <script>
        // ==================== é…ç½®å¸¸é‡ ====================
        const DATA_JSON_URL = 'data/latest.json';

        // æ’é™¤çš„æµ‹è¯•IDåˆ—è¡¨ï¼ˆå·²åœ¨æœåŠ¡ç«¯æ¸…æ´—ï¼Œæ­¤å¤„ä¿ç•™ä½œä¸ºå‚è€ƒï¼‰
        const EXCLUDE_IDS = [
            'trial-e5b50d8e-3856-49d4-8633-2a67f41923ce',
            'trial-e21c6843-aea3-4910-ac71-9aff35dc91e1',
            'trial-2b26b557-4022-44ad-9cb1-f58b3f495468',
            'trial-2da1f8c6-6f9e-40a4-a528-73ffc3b448d5',
            'trial-2f87736a-0290-42a7-b4a3-f613c97ae1d4',
            'trial-7b89c5d1-1e5c-43ab-b3fd-639765f9673c',
            'trial-ca39a16e-5bf4-4343-9a2e-4d9bfb2f958f',
            'trial-0855ab37-8162-4796-ad94-a5c50d59496a',
            'trial-958b9b91-bd45-4e1a-aadf-6f3b075cee26',
            'trial-4e1078af-2d27-46f5-9ec0-f0d471739d9b',
            'trial-4f494b3a-dc0c-4060-bfc9-0b668698e0ff',
            'trial-b63973da-6d4c-4115-a2f1-6acf5c046895',
            'trial-3d5b5e7c-987d-4046-be68-39c7ba6ca430',
            'trial-abac2152-7833-40f0-8f65-b37de1456ee3',
            'trial-0a91baac-888a-4d27-a7c5-8077c73389e1',
            'trial-9396417e-5275-4449-98c0-e770d2c116a0',
            'a277d75e-ffee-45ff-94bf-9a6026506444',
            'da8106e5-2185-466e-bf6d-40ad88eeaa08',
            '5808ec25-e74e-4d54-821c-891079f42de8',
            '493a1fbb-d2d6-45a2-a161-3abea8d97265',
            'a4cb4615-b699-4356-940b-010d739b1ea1',
            '824c588c-a177-4737-95c6-9b94cb1aa5c9'
        ];

        // ==================== å…¨å±€å˜é‡ ====================
        let rawData = [];
        let currentData = [];
        let lastWeekData = [];
        let chartInstances = {};

        // ==================== å·¥å…·å‡½æ•° ====================

        // æ˜¾ç¤ºæŒ‡æ ‡è¯´æ˜
        function showMetricHelp(metricName) {
            const descriptions = {
                'total-users': 'ã€æ´»è·ƒç”¨æˆ·æ•°ã€‘ç»Ÿè®¡æ—¶é—´èŒƒå›´å†…æœ‰æ´»åŠ¨è®°å½•çš„ç‹¬ç«‹ç”¨æˆ·æ•°é‡ï¼ˆå»é‡åçš„user_idæ•°é‡ï¼‰',
                'enter-rate': 'ã€è¿›å…¥é—®è¯Šç‡ã€‘è¿›å…¥é—®è¯Šçš„ç”¨æˆ·æ•° / æ´»è·ƒç”¨æˆ·æ•° Ã— 100%ã€‚è¡¡é‡ç”¨æˆ·ä»å¼•å¯¼é¡µåˆ°é—®è¯Šé¡µçš„è½¬åŒ–ç‡',
                'diagnosis-rate': 'ã€æ´»è·ƒç‡ã€‘æœ‰è¯Šæ–­è¡Œä¸ºçš„ç”¨æˆ·æ•° / æ´»è·ƒç”¨æˆ·æ•° Ã— 100%ã€‚è¯Šæ–­è¡Œä¸ºåŒ…æ‹¬ï¼šå‘é€æ¶ˆæ¯ã€æŸ¥çœ‹è¯Šæ–­ç»“è®ºç­‰äº¤äº’æ“ä½œ',
                'complete-rate': 'ã€å®Œæˆç‡ã€‘æŸ¥çœ‹è¯„åˆ†é¡µé¢çš„ç”¨æˆ·æ•° / æ´»è·ƒç”¨æˆ·æ•° Ã— 100%ã€‚è¡¡é‡å®Œæ•´å®Œæˆé—®è¯Šæµç¨‹çš„ç”¨æˆ·æ¯”ä¾‹',
                'retention-rate': 'ã€æ¬¡æ—¥ç•™å­˜ç‡ã€‘è®¡ç®—æ—¶é—´èŒƒå›´å†…æ‰€æœ‰ç›¸é‚»æ—¥æœŸçš„å¹³å‡ç•™å­˜ç‡ã€‚æ¯å¯¹ç›¸é‚»æ—¥æœŸï¼šå½“æ—¥æ´»è·ƒç”¨æˆ·ä¸­æ¬¡æ—¥å›è®¿çš„ç”¨æˆ·å æ¯”',
                'cumulative-users': 'ã€å¹³å°ç´¯è®¡ç”¨æˆ·ã€‘ä»å¹³å°ä¸Šçº¿è‡³ä»Šï¼Œæ‰€æœ‰å†å²æ•°æ®ä¸­çš„ç‹¬ç«‹ç”¨æˆ·æ€»æ•°ï¼ˆåŒ…å«æ‰€æœ‰æ—¶é—´æ®µçš„ç”¨æˆ·å»é‡ï¼‰ã€‚æ­¤æŒ‡æ ‡ä¸å—ç­›é€‰æ—¶é—´èŒƒå›´å½±å“',
                'returning-users': 'ã€å›è®¿ç”¨æˆ·æ•°ã€‘æ—¶é—´èŒƒå›´å†…ï¼Œè¿›å…¥é—®è¯Šä½†æœªå®Œæˆç§‘å®¤é€‰æ‹©çš„ç”¨æˆ·æ•°ã€‚é€šå¸¸ä¸ºè€ç”¨æˆ·ç›´æ¥è®¿é—®é—®è¯Šé¡µ',
                'first-users': 'ã€æ–°ç”¨æˆ·æ•°ã€‘æ—¶é—´èŒƒå›´å†…ï¼Œå®Œæˆç§‘å®¤é€‰æ‹©çš„ç”¨æˆ·æ•°ã€‚é€šå¸¸ä¸ºé¦–æ¬¡è®¿é—®çš„æ–°ç”¨æˆ·'
            };

            const description = descriptions[metricName] || 'æš‚æ— è¯´æ˜';
            alert(`ğŸ“Š æŒ‡æ ‡è¯´æ˜\n\n${description}`);
        }

        // ====================

        // è·å–æ˜¨å¤©çš„æ—¥æœŸï¼ˆ23:59:59ï¼‰
        function getYesterday() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            date.setHours(23, 59, 59, 999);
            return date;
        }

        // è·å–Nå¤©å‰çš„æ—¥æœŸï¼ˆ00:00:00ï¼‰
        function getDaysAgo(days) {
            const date = new Date();
            date.setDate(date.getDate() - days);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // æ˜¾ç¤º/éšè—åŠ è½½æç¤º
        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        // ==================== æ•°æ®åŠ è½½ ====================

        async function loadData() {
            showLoading(true);
            try {
                // æ·»åŠ æ—¶é—´æˆ³å‚æ•°ç ´åç¼“å­˜
                const cacheBuster = new Date().getTime();
                const response = await fetch(`${DATA_JSON_URL}?t=${cacheBuster}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const jsonResponse = await response.json();
                console.log('åŠ è½½æ•°æ®æˆåŠŸ:', jsonResponse.dataCount, 'æ¡è®°å½•,', jsonResponse.userCount, 'ä¸ªç”¨æˆ·');
                console.log('æ•°æ®æ›´æ–°æ—¶é—´:', jsonResponse.updateTime);

                // æå–æ•°æ®å¹¶è½¬æ¢æ—¶é—´æ ¼å¼
                const jsonData = jsonResponse.data.map(row => ({
                    ...row,
                    time: new Date(row.time)  // å°†ISOæ—¶é—´å­—ç¬¦ä¸²è½¬ä¸ºDateå¯¹è±¡
                }));

                rawData = jsonData;  // æ•°æ®å·²åœ¨æœåŠ¡ç«¯æ¸…æ´—ï¼Œç›´æ¥ä½¿ç”¨

                // æ˜¾ç¤ºæ•°æ®æ›´æ–°æ—¶é—´
                const updateTime = new Date(jsonResponse.updateTime);
                const updateTimeStr = updateTime.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('refresh-text').textContent = `æœ€åæ›´æ–°: ${updateTimeStr}`;

                // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæ˜¨å¤©å¾€å‰æ¨7å¤©ï¼‰
                const yesterday = getYesterday();
                const sevenDaysAgo = getDaysAgo(8); // å¾€å‰æ¨8å¤©ï¼Œè·å–7å¤©æ•°æ®

                applyDefaultFilter(sevenDaysAgo, yesterday);

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // æ•°æ®æ¸…æ´—ï¼ˆå·²åœ¨æœåŠ¡ç«¯å®Œæˆï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼‰
        function cleanData(data) {
            return data.filter(row => {
                // æ’é™¤æµ‹è¯•ID
                if (EXCLUDE_IDS.includes(row.user_id)) {
                    return false;
                }
                // æ’é™¤ksbaoUserIdä¸ºç©º
                if (!row.ksbaoUserId) {
                    return false;
                }
                return true;
            }).map(row => {
                // ç¡®ä¿æ—¶é—´å­—æ®µæ˜¯Dateå¯¹è±¡
                if (row.time && !(row.time instanceof Date)) {
                    row.time = new Date(row.time);
                }
                return row;
            });
        }

        // åº”ç”¨é»˜è®¤ç­›é€‰
        function applyDefaultFilter(startDate, endDate) {
            currentData = rawData.filter(row => {
                return row.time >= startDate && row.time <= endDate;
            });

            // åŠ è½½ä¸Šå‘¨æ•°æ®ç”¨äºå¯¹æ¯”
            const lastWeekStart = new Date(startDate);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            const lastWeekEnd = new Date(endDate);
            lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);

            lastWeekData = rawData.filter(row => {
                return row.time >= lastWeekStart && row.time <= lastWeekEnd;
            });

            // æ›´æ–°æ—¶é—´èŒƒå›´æ˜¾ç¤º
            document.getElementById('data-time-range').textContent =
                `${formatDate(startDate)} è‡³ ${formatDate(endDate)}`;

            // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
            initDatePicker(startDate, endDate);

            // è®¡ç®—å¹¶æ¸²æŸ“
            calculateAndRender();
        }

        // ==================== æ—¥æœŸé€‰æ‹©å™¨åˆå§‹åŒ– ====================

        function initDatePicker(startDate, endDate) {
            flatpickr("#date-range-picker", {
                mode: "range",
                locale: "zh",
                dateFormat: "Y-m-d",
                defaultDate: [startDate, endDate],
                onChange: function (selectedDates) {
                    if (selectedDates.length === 2) {
                        // ç”¨æˆ·é€‰æ‹©äº†æ—¥æœŸèŒƒå›´ï¼Œæš‚ä¸è‡ªåŠ¨åº”ç”¨
                        console.log('æ—¥æœŸèŒƒå›´å·²é€‰æ‹©:', selectedDates);
                    }
                }
            });
        }

        // ==================== æŒ‡æ ‡è®¡ç®— ====================

        function calculateMetrics(data) {
            const totalUsers = new Set(data.map(r => r.user_id)).size;

            // è¯†åˆ«elementå­—æ®µæ ¼å¼
            const hasChineseElement = data.some(r => r.element && /[\u4e00-\u9fa5]/.test(r.element));

            let guideUsers, enterChatUsers, diagnosisUsers, finishUsers, selectDeptUsers;

            if (hasChineseElement) {
                // ä¸­æ–‡æ ¼å¼
                guideUsers = new Set(data.filter(r => r.element === 'å¼•å¯¼é¡µè®¿é—®').map(r => r.user_id)).size;
                selectDeptUsers = new Set(data.filter(r => r.element && r.element.includes('ç§‘å®¤é€‰æ‹©:')).map(r => r.user_id)).size;
                enterChatUsers = new Set(data.filter(r => r.element === 'é—®è¯Šå¼€å§‹').map(r => r.user_id)).size;
                diagnosisUsers = new Set(data.filter(r => r.element && (r.element.includes('è¯Šæ–­ç»“è®º:') || r.element.includes('åŒ»ç”Ÿæé—®:'))).map(r => r.user_id)).size;
                finishUsers = new Set(data.filter(r => r.element === 'è¯„åˆ†å±•ç¤º').map(r => r.user_id)).size;
            } else {
                // è‹±æ–‡æ ¼å¼
                guideUsers = new Set(data.filter(r => r.element === 'come to home page').map(r => r.user_id)).size;
                selectDeptUsers = new Set(data.filter(r => r.element && r.element.includes('select department')).map(r => r.user_id)).size;
                enterChatUsers = new Set(data.filter(r => r.element === 'come to chat page').map(r => r.user_id)).size;
                diagnosisUsers = new Set(data.filter(r => r.element === 'send message').map(r => r.user_id)).size;
                finishUsers = new Set(data.filter(r => r.element === 'finish chat').map(r => r.user_id)).size;
            }

            // ç”¨æˆ·åˆ†ç±»
            const firstTimeUserIds = new Set(data.filter(r => {
                if (hasChineseElement) {
                    return r.element && r.element.includes('ç§‘å®¤é€‰æ‹©:');
                } else {
                    return r.element && r.element.includes('select department');
                }
            }).map(r => r.user_id));

            const enterChatUserIds = new Set(data.filter(r => {
                if (hasChineseElement) {
                    return r.element === 'é—®è¯Šå¼€å§‹';
                } else {
                    return r.element === 'come to chat page';
                }
            }).map(r => r.user_id));

            const returningUserIds = new Set([...enterChatUserIds].filter(id => !firstTimeUserIds.has(id)));

            // è®¡ç®—æ–°ç”¨æˆ·æ¼æ–—æ•°æ®
            const newUserGuide = new Set(data.filter(r => {
                const isGuide = hasChineseElement ? r.element === 'å¼•å¯¼é¡µè®¿é—®' : r.element === 'come to home page';
                return isGuide && firstTimeUserIds.has(r.user_id);
            }).map(r => r.user_id)).size;

            const newUserSelectDept = firstTimeUserIds.size;

            const newUserEnterChat = new Set(data.filter(r => {
                const isEnterChat = hasChineseElement ? r.element === 'é—®è¯Šå¼€å§‹' : r.element === 'come to chat page';
                return isEnterChat && firstTimeUserIds.has(r.user_id);
            }).map(r => r.user_id)).size;

            const newUserDiagnosis = new Set(data.filter(r => {
                const isDiagnosis = hasChineseElement ?
                    (r.element && (r.element.includes('è¯Šæ–­ç»“è®º:') || r.element.includes('åŒ»ç”Ÿæé—®:'))) :
                    r.element === 'send message';
                return isDiagnosis && firstTimeUserIds.has(r.user_id);
            }).map(r => r.user_id)).size;

            const newUserFinish = new Set(data.filter(r => {
                const isFinish = hasChineseElement ? r.element === 'è¯„åˆ†å±•ç¤º' : r.element === 'finish chat';
                return isFinish && firstTimeUserIds.has(r.user_id);
            }).map(r => r.user_id)).size;

            // è®¡ç®—è€ç”¨æˆ·æ¼æ–—æ•°æ®
            const returningUserEnterChat = returningUserIds.size;

            const returningUserDiagnosis = new Set(data.filter(r => {
                const isDiagnosis = hasChineseElement ?
                    (r.element && (r.element.includes('è¯Šæ–­ç»“è®º:') || r.element.includes('åŒ»ç”Ÿæé—®:'))) :
                    r.element === 'send message';
                return isDiagnosis && returningUserIds.has(r.user_id);
            }).map(r => r.user_id)).size;

            const returningUserFinish = new Set(data.filter(r => {
                const isFinish = hasChineseElement ? r.element === 'è¯„åˆ†å±•ç¤º' : r.element === 'finish chat';
                return isFinish && returningUserIds.has(r.user_id);
            }).map(r => r.user_id)).size;

            return {
                totalUsers,
                guideUsers,
                selectDeptUsers,
                enterChatUsers,
                diagnosisUsers,
                finishUsers,
                firstTimeUsers: firstTimeUserIds.size,
                returningUsers: returningUserIds.size,
                enterRate: totalUsers > 0 ? (enterChatUsers / totalUsers * 100).toFixed(1) : 0,
                diagnosisRate: totalUsers > 0 ? (diagnosisUsers / totalUsers * 100).toFixed(1) : 0,
                completeRate: totalUsers > 0 ? (finishUsers / totalUsers * 100).toFixed(1) : 0,
                // æ–°ç”¨æˆ·æ¼æ–—æ•°æ®
                newUserFunnel: {
                    guide: newUserGuide,
                    selectDept: newUserSelectDept,
                    enterChat: newUserEnterChat,
                    diagnosis: newUserDiagnosis,
                    finish: newUserFinish
                },
                // è€ç”¨æˆ·æ¼æ–—æ•°æ®
                returningUserFunnel: {
                    enterChat: returningUserEnterChat,
                    diagnosis: returningUserDiagnosis,
                    finish: returningUserFinish
                }
            };
        }

        // è®¡ç®—ç•™å­˜ç‡ï¼ˆæ¬¡æ—¥ç•™å­˜ï¼šæ•´ä¸ªæ—¶é—´æ®µå†…ç›¸é‚»æ—¥æœŸçš„å¹³å‡ç•™å­˜ç‡ï¼‰
        function calculateRetention(currentData, lastWeekData) {
            if (currentData.length === 0) return 0;

            // æŒ‰æ—¥æœŸåˆ†ç»„ç”¨æˆ·æ´»åŠ¨
            const usersByDate = {};
            currentData.forEach(r => {
                const dateKey = r.time.toISOString().split('T')[0]; // YYYY-MM-DD
                if (!usersByDate[dateKey]) {
                    usersByDate[dateKey] = new Set();
                }
                usersByDate[dateKey].add(r.user_id);
            });

            // è·å–æ‰€æœ‰æ—¥æœŸå¹¶æ’åº
            const dates = Object.keys(usersByDate).sort();

            if (dates.length < 2) {
                return 0; // éœ€è¦è‡³å°‘2å¤©çš„æ•°æ®æ‰èƒ½è®¡ç®—ç•™å­˜
            }

            // è®¡ç®—æ¯å¯¹ç›¸é‚»æ—¥æœŸçš„ç•™å­˜ç‡
            const retentionRates = [];
            for (let i = 0; i < dates.length - 1; i++) {
                const today = dates[i];
                const tomorrow = dates[i + 1];

                const todayUsers = usersByDate[today];
                const tomorrowUsers = usersByDate[tomorrow];

                // ä»Šå¤©çš„ç”¨æˆ·ä¸­ï¼Œæ˜å¤©å›è®¿çš„æ•°é‡
                const returnedCount = [...todayUsers].filter(userId => tomorrowUsers.has(userId)).length;

                if (todayUsers.size > 0) {
                    const rate = (returnedCount / todayUsers.size) * 100;
                    retentionRates.push(rate);
                }
            }

            // è¿”å›å¹³å‡ç•™å­˜ç‡
            if (retentionRates.length === 0) return 0;
            const avgRate = retentionRates.reduce((sum, rate) => sum + rate, 0) / retentionRates.length;

            console.log('æ¬¡æ—¥ç•™å­˜ç‡è®¡ç®—:', {
                æ—¥æœŸèŒƒå›´: `${dates[0]} è‡³ ${dates[dates.length - 1]}`,
                ç›¸é‚»æ—¥æœŸå¯¹æ•°: retentionRates.length,
                å„æ—¥ç•™å­˜ç‡: retentionRates.map(r => r.toFixed(1) + '%'),
                å¹³å‡ç•™å­˜ç‡: avgRate.toFixed(1) + '%'
            });

            return avgRate.toFixed(1);
        }

        // è®¡ç®—å¹³å°ç´¯è®¡ç”¨æˆ·
        function calculateCumulativeUsers() {
            return new Set(rawData.map(r => r.user_id)).size;
        }

        // ==================== å›¾è¡¨æ¸²æŸ“ ====================

        function calculateAndRender() {
            const currentMetrics = calculateMetrics(currentData);
            const lastWeekMetrics = calculateMetrics(lastWeekData);
            const retentionRate = calculateRetention(currentData, lastWeekData);
            const cumulativeUsers = calculateCumulativeUsers();

            console.log('å½“å‰æŒ‡æ ‡:', currentMetrics);
            console.log('ä¸Šå‘¨æŒ‡æ ‡:', lastWeekMetrics);

            // æ›´æ–°KPIå¡ç‰‡
            updateKPICards(currentMetrics, lastWeekMetrics, retentionRate, cumulativeUsers);

            // æ¸²æŸ“å›¾è¡¨
            renderFunnelChart(currentMetrics);
            renderTrendChart();
            renderUserTypeChart(currentMetrics);
            renderDepartmentChart();
            renderFeatureUsageChart();
            renderFeedbackList();
        }

        // æ›´æ–°KPIå¡ç‰‡
        function updateKPICards(current, last, retentionRate, cumulativeUsers) {
            // æ€»ç”¨æˆ·æ•°
            updateKPICard('total-users', current.totalUsers, last.totalUsers);

            // è¿›å…¥é—®è¯Šç‡
            updateKPICard('enter-rate', current.enterRate + '%', last.enterRate + '%', true);

            // è¯Šæ–­è¡Œä¸ºç‡
            updateKPICard('diagnosis-rate', current.diagnosisRate + '%', last.diagnosisRate + '%', true);

            // å®Œæˆç‡
            updateKPICard('complete-rate', current.completeRate + '%', last.completeRate + '%', true);

            // æ¬¡æ—¥ç•™å­˜ç‡
            const lastRetention = calculateRetention(lastWeekData, []);
            updateKPICard('retention-rate', retentionRate + '%', lastRetention + '%', true);

            // å¹³å°ç´¯è®¡ç”¨æˆ·ï¼ˆå¯¹æ¯”å€¼ä¸ºï¼šæ’é™¤æœ¬å‘¨æ–°å¢ç”¨æˆ·åçš„ç´¯è®¡ç”¨æˆ·ï¼‰
            // è®¡ç®—æœ¬å‘¨æ–°å¢çš„ç”¨æˆ·æ•°
            const currentUserIds = new Set(currentData.map(r => r.user_id));
            const lastWeekUserIds = new Set(lastWeekData.map(r => r.user_id));
            const allUserIds = new Set(rawData.map(r => r.user_id));

            // ä¸Šå‘¨æ•°æ®ä¸­çš„æ‰€æœ‰ç”¨æˆ·ï¼ˆæ’é™¤æœ¬å‘¨æ•°æ®ä¸­çš„æ–°å¢ï¼‰
            const usersBeforeThisWeek = new Set(
                rawData.filter(r => {
                    const eventTime = new Date(r.time);
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return eventTime < weekAgo;
                }).map(r => r.user_id)
            );
            const lastCumulativeUsers = usersBeforeThisWeek.size || cumulativeUsers;

            updateKPICard('cumulative-users', cumulativeUsers, lastCumulativeUsers);

            // å›è®¿ç”¨æˆ·æ•°
            updateKPICard('returning-users', current.returningUsers, last.returningUsers);

            // é¦–æ¬¡ç”¨æˆ·æ•°
            updateKPICard('first-users', current.firstTimeUsers, last.firstTimeUsers);
        }

        function updateKPICard(name, currentValue, lastValue, isPercentage = false) {
            document.getElementById(`kpi-${name}`).textContent = currentValue;

            const currentNum = parseFloat(currentValue);
            const lastNum = parseFloat(lastValue);

            if (lastNum > 0) {
                const change = ((currentNum - lastNum) / lastNum * 100).toFixed(1);
                const changeText = change > 0 ? `â†‘ ${change}%` : change < 0 ? `â†“ ${Math.abs(change)}%` : 'æŒå¹³';
                const changeClass = change > 0 ? 'trend-up' : change < 0 ? 'trend-down' : 'trend-neutral';

                const changeElement = document.getElementById(`kpi-${name}-change`);
                changeElement.textContent = `vsä¸Šå‘¨ ${changeText}`;
                changeElement.className = `text-sm mt-1 ${changeClass}`;
            } else {
                const changeElement = document.getElementById(`kpi-${name}-change`);
                changeElement.textContent = 'æš‚æ— å¯¹æ¯”æ•°æ®';
                changeElement.className = 'text-sm mt-1 trend-neutral';
            }

            // æ¸²æŸ“è¿·ä½ è¶‹åŠ¿å›¾
            renderMiniChart(`kpi-${name}-chart`, [lastNum, currentNum]);
        }

        // æ¸²æŸ“è¿·ä½ è¶‹åŠ¿å›¾
        function renderMiniChart(elementId, data) {
            const chartDom = document.getElementById(elementId);
            if (!chartDom) return;

            let chart = chartInstances[elementId];
            if (!chart) {
                chart = echarts.init(chartDom);
                chartInstances[elementId] = chart;
            }

            const option = {
                grid: { left: 0, right: 0, top: 0, bottom: 0 },
                xAxis: { type: 'category', show: false },
                yAxis: { type: 'value', show: false },
                series: [{
                    data: data,
                    type: 'line',
                    smooth: true,
                    symbol: 'none',
                    lineStyle: { width: 2, color: '#3B82F6' },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                            { offset: 1, color: 'rgba(59, 130, 246, 0)' }
                        ])
                    }
                }]
            };

            chart.setOption(option);
        }

        // æ¸²æŸ“è½¬åŒ–æ¼æ–—å›¾ï¼ˆæ–°ç”¨æˆ·å’Œè€ç”¨æˆ·åˆ†å¼€ï¼‰
        function renderFunnelChart(metrics) {
            const chartDom = document.getElementById('funnel-chart');
            let chart = chartInstances['funnel-chart'];
            if (!chart) {
                chart = echarts.init(chartDom);
                chartInstances['funnel-chart'] = chart;
            }

            const option = {
                title: [
                    {
                        text: 'æ–°ç”¨æˆ·è½¬åŒ–æ¼æ–—',
                        left: '25%',
                        textAlign: 'center',
                        top: 10,
                        textStyle: {
                            fontSize: 16,
                            fontWeight: 'bold'
                        }
                    },
                    {
                        text: 'è€ç”¨æˆ·è½¬åŒ–æ¼æ–—',
                        left: '75%',
                        textAlign: 'center',
                        top: 10,
                        textStyle: {
                            fontSize: 16,
                            fontWeight: 'bold'
                        }
                    }
                ],
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        const percent = ((params.value / params.data.total) * 100).toFixed(1);
                        return `${params.seriesName}<br/>${params.name}: ${params.value}äºº (${percent}%)`;
                    }
                },
                series: [
                    {
                        name: 'æ–°ç”¨æˆ·',
                        type: 'funnel',
                        left: '5%',
                        top: 60,
                        bottom: 60,
                        width: '40%',
                        min: 0,
                        max: metrics.newUserFunnel.guide || metrics.newUserFunnel.selectDept,
                        minSize: '0%',
                        maxSize: '100%',
                        sort: 'descending',
                        gap: 2,
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: '{b}: {c}äºº',
                            fontSize: 12
                        },
                        labelLine: {
                            length: 10,
                            lineStyle: {
                                width: 1,
                                type: 'solid'
                            }
                        },
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 1
                        },
                        emphasis: {
                            label: {
                                fontSize: 16
                            }
                        },
                        data: [
                            {
                                value: metrics.newUserFunnel.guide || metrics.newUserFunnel.selectDept,
                                name: 'è®¿é—®å¼•å¯¼é¡µ',
                                total: metrics.newUserFunnel.guide || metrics.newUserFunnel.selectDept
                            },
                            {
                                value: metrics.newUserFunnel.selectDept,
                                name: 'å®Œæˆç§‘å®¤é€‰æ‹©',
                                total: metrics.newUserFunnel.guide || metrics.newUserFunnel.selectDept
                            },
                            {
                                value: metrics.newUserFunnel.enterChat,
                                name: 'è¿›å…¥é—®è¯Š',
                                total: metrics.newUserFunnel.guide || metrics.newUserFunnel.selectDept
                            },
                            {
                                value: metrics.newUserFunnel.diagnosis,
                                name: 'æœ‰è¯Šæ–­è¡Œä¸º',
                                total: metrics.newUserFunnel.guide || metrics.newUserFunnel.selectDept
                            },
                            {
                                value: metrics.newUserFunnel.finish,
                                name: 'æŸ¥çœ‹è¯„åˆ†',
                                total: metrics.newUserFunnel.guide || metrics.newUserFunnel.selectDept
                            }
                        ]
                    },
                    {
                        name: 'è€ç”¨æˆ·',
                        type: 'funnel',
                        left: '55%',
                        top: 60,
                        bottom: 60,
                        width: '40%',
                        min: 0,
                        max: metrics.returningUserFunnel.enterChat,
                        minSize: '0%',
                        maxSize: '100%',
                        sort: 'descending',
                        gap: 2,
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: '{b}: {c}äºº',
                            fontSize: 12
                        },
                        labelLine: {
                            length: 10,
                            lineStyle: {
                                width: 1,
                                type: 'solid'
                            }
                        },
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 1,
                            color: function (params) {
                                const colors = ['#91cc75', '#fac858', '#ee6666'];
                                return colors[params.dataIndex];
                            }
                        },
                        emphasis: {
                            label: {
                                fontSize: 16
                            }
                        },
                        data: [
                            {
                                value: metrics.returningUserFunnel.enterChat,
                                name: 'è¿›å…¥é—®è¯Š',
                                total: metrics.returningUserFunnel.enterChat
                            },
                            {
                                value: metrics.returningUserFunnel.diagnosis,
                                name: 'æœ‰è¯Šæ–­è¡Œä¸º',
                                total: metrics.returningUserFunnel.enterChat
                            },
                            {
                                value: metrics.returningUserFunnel.finish,
                                name: 'æŸ¥çœ‹è¯„åˆ†',
                                total: metrics.returningUserFunnel.enterChat
                            }
                        ]
                    }
                ]
            };

            chart.setOption(option);
        }

        // æ¸²æŸ“ç”¨æˆ·è¶‹åŠ¿å›¾
        function renderTrendChart() {
            const chartDom = document.getElementById('trend-chart');
            let chart = chartInstances['trend-chart'];
            if (!chart) {
                chart = echarts.init(chartDom);
                chartInstances['trend-chart'] = chart;
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„ç»Ÿè®¡
            const dateMap = {};
            currentData.forEach(row => {
                const dateStr = formatDate(row.time);
                if (!dateMap[dateStr]) {
                    dateMap[dateStr] = new Set();
                }
                dateMap[dateStr].add(row.user_id);
            });

            const dates = Object.keys(dateMap).sort();
            const dailyUsers = dates.map(date => dateMap[date].size);

            const option = {
                title: {
                    text: 'æ¯æ—¥ç”¨æˆ·æ´»è·ƒè¶‹åŠ¿',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['æ´»è·ƒç”¨æˆ·æ•°'],
                    top: 30
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    name: 'æ´»è·ƒç”¨æˆ·æ•°',
                    type: 'line',
                    smooth: true,
                    data: dailyUsers,
                    lineStyle: {
                        color: '#3B82F6',
                        width: 3
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                            { offset: 1, color: 'rgba(59, 130, 246, 0.05)' }
                        ])
                    },
                    itemStyle: {
                        color: '#3B82F6'
                    }
                }]
            };

            chart.setOption(option);
        }

        // æ¸²æŸ“ç”¨æˆ·ç±»å‹é¥¼å›¾
        function renderUserTypeChart(metrics) {
            const chartDom = document.getElementById('user-type-chart');
            let chart = chartInstances['user-type-chart'];
            if (!chart) {
                chart = echarts.init(chartDom);
                chartInstances['user-type-chart'] = chart;
            }

            const option = {
                title: {
                    text: 'ç”¨æˆ·ç±»å‹åˆ†å¸ƒ',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c}äºº ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 'middle'
                },
                series: [{
                    name: 'ç”¨æˆ·ç±»å‹',
                    type: 'pie',
                    radius: '60%',
                    center: ['60%', '50%'],
                    data: [
                        { value: metrics.firstTimeUsers, name: 'æ–°ç”¨æˆ·' },
                        { value: metrics.returningUsers, name: 'å›è®¿ç”¨æˆ·' }
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    },
                    label: {
                        formatter: '{b}\n{c}äºº ({d}%)'
                    }
                }]
            };

            chart.setOption(option);
        }

        // æ¸²æŸ“ç§‘å®¤åˆ†å¸ƒå›¾
        function renderDepartmentChart() {
            const chartDom = document.getElementById('department-chart');
            let chart = chartInstances['department-chart'];
            if (!chart) {
                chart = echarts.init(chartDom);
                chartInstances['department-chart'] = chart;
            }

            // ç»Ÿè®¡ç§‘å®¤åˆ†å¸ƒ
            const hasChineseElement = currentData.some(r => r.element && /[\u4e00-\u9fa5]/.test(r.element));
            let deptData = [];

            if (hasChineseElement) {
                const deptMap = {};
                currentData.forEach(row => {
                    if (row.element && row.element.includes('ç§‘å®¤é€‰æ‹©:')) {
                        const dept = row.element.replace('ç§‘å®¤é€‰æ‹©:', '');
                        deptMap[dept] = (deptMap[dept] || 0) + 1;
                    }
                });
                deptData = Object.entries(deptMap)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);
            } else {
                // è‹±æ–‡æ ¼å¼
                const deptMap = {};
                currentData.forEach(row => {
                    if (row.element && row.element.includes('select department')) {
                        const dept = row.element.replace('select department: ', '');
                        deptMap[dept] = (deptMap[dept] || 0) + 1;
                    }
                });
                deptData = Object.entries(deptMap)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 10);
            }

            if (deptData.length === 0) {
                deptData = [{ name: 'æš‚æ— æ•°æ®', value: 0 }];
            }

            const option = {
                title: {
                    text: 'Top 10 ç§‘å®¤é€‰æ‹©åˆ†å¸ƒ',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value'
                },
                yAxis: {
                    type: 'category',
                    data: deptData.map(d => d.name).reverse()
                },
                series: [{
                    type: 'bar',
                    data: deptData.map(d => d.value).reverse(),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#3B82F6' },
                            { offset: 1, color: '#60A5FA' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: '{c}æ¬¡'
                    }
                }]
            };

            chart.setOption(option);
        }

        // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨åˆ†æå›¾
        function renderFeatureUsageChart() {
            const chartDom = document.getElementById('feature-usage-chart');
            let chart = chartInstances['feature-usage-chart'];
            if (!chart) {
                chart = echarts.init(chartDom);
                chartInstances['feature-usage-chart'] = chart;
            }

            const hasChineseElement = currentData.some(r => r.element && /[\u4e00-\u9fa5]/.test(r.element));

            let features = [];
            if (hasChineseElement) {
                features = [
                    { name: 'è·å–å¿«æ·æé—®', element: 'è·å–å¿«æ·æé—®' },
                    { name: 'ç—…ä¾‹åˆ·æ–°', element: 'ç—…ä¾‹åˆ·æ–°' },
                    { name: 'å¼€å¯æ–°ç—…ä¾‹', element: 'å¼€å¯æ–°ç—…ä¾‹' },
                    { name: 'åˆ‡æ¢ç§‘å®¤', element: 'ç‚¹å‡»åˆ‡æ¢ç§‘å®¤æŒ‰é’®' },
                    { name: 'ç‚¹å¼€ä¸ªäººä¸­å¿ƒ', element: 'ç‚¹å¼€ä¸ªäººä¸­å¿ƒ' },
                    { name: 'å¼€å§‹ç ”ä¹ æŒ‰é’®', element: 'å¼€å§‹ç ”ä¹ æŒ‰é’®' },
                    { name: 'è·³è¿‡æŒ‰é’®', element: 'è·³è¿‡æŒ‰é’®' }
                ];
            } else {
                // è‹±æ–‡æ ¼å¼çš„åŠŸèƒ½æ˜ å°„
                features = [];
            }

            const totalUsers = calculateMetrics(currentData).totalUsers;
            const featureData = features.map(feature => {
                const users = new Set(currentData.filter(r => r.element === feature.element).map(r => r.user_id)).size;
                const rate = totalUsers > 0 ? (users / totalUsers * 100).toFixed(1) : 0;
                return {
                    name: feature.name,
                    users: users,
                    rate: parseFloat(rate)
                };
            }).filter(f => f.users > 0).sort((a, b) => b.users - a.users);

            if (featureData.length === 0) {
                featureData.push({ name: 'æš‚æ— æ•°æ®', users: 0, rate: 0 });
            }

            const option = {
                title: {
                    text: 'åŠŸèƒ½ä½¿ç”¨ç‡ç»Ÿè®¡',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: '{b}<br/>ä½¿ç”¨äººæ•°: {c}äºº'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value'
                },
                yAxis: {
                    type: 'category',
                    data: featureData.map(d => d.name).reverse()
                },
                series: [{
                    type: 'bar',
                    data: featureData.map(d => d.users).reverse(),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#10B981' },
                            { offset: 1, color: '#34D399' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: function (params) {
                            const item = featureData[featureData.length - 1 - params.dataIndex];
                            return `${item.users}äºº (${item.rate}%)`;
                        }
                    }
                }]
            };

            chart.setOption(option);
        }

        // æ¸²æŸ“ç”¨æˆ·åé¦ˆåˆ—è¡¨
        function renderFeedbackList() {
            // æ”¶é›†æ‰€æœ‰ç”¨æˆ·è¾“å…¥çš„åé¦ˆå†…å®¹
            const allFeedback = [];

            // 1. ç§‘å®¤éœ€æ±‚åé¦ˆ
            rawData.filter(r => r.element && r.element.includes('æäº¤æ— ç§‘å®¤åé¦ˆ:'))
                .forEach(r => {
                    const content = r.element.split('æäº¤æ— ç§‘å®¤åé¦ˆ:')[1] || '';
                    allFeedback.push({
                        type: 'department',
                        typeName: 'ç§‘å®¤éœ€æ±‚',
                        typeColor: 'orange',
                        content: content.trim(),
                        km: r.km || 'æœªçŸ¥ç§‘ç›®',
                        time: new Date(r.time),
                        userId: r.user_id,
                        isVip: r.is_vip
                    });
                });

            // 2. ç”¨æˆ·é—®è¯Šè¾“å…¥ï¼ˆåŒ»ç”Ÿæé—®å®é™…æ˜¯ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼‰
            rawData.filter(r => r.element && r.element.startsWith('åŒ»ç”Ÿæé—®:') && r.action_type === 'submit')
                .forEach(r => {
                    const content = r.element.split('åŒ»ç”Ÿæé—®:')[1] || '';
                    // è¿‡æ»¤æ‰å¤ªçŸ­æˆ–çº¯æ•°å­—çš„å†…å®¹
                    if (content.length > 2 && !/^\d+$/.test(content)) {
                        allFeedback.push({
                            type: 'question',
                            typeName: 'é—®è¯Šè¾“å…¥',
                            typeColor: 'blue',
                            content: content.trim(),
                            km: r.km || 'æœªçŸ¥ç§‘ç›®',
                            time: new Date(r.time),
                            userId: r.user_id,
                            isVip: r.is_vip
                        });
                    }
                });

            // 3. è¯Šæ–­ç»“è®ºè¾“å…¥
            rawData.filter(r => r.element && r.element.startsWith('è¯Šæ–­ç»“è®º:'))
                .forEach(r => {
                    const content = r.element.split('è¯Šæ–­ç»“è®º:')[1] || '';
                    // è¿‡æ»¤æ‰å¤ªçŸ­æˆ–çº¯æ•°å­—çš„å†…å®¹
                    if (content.length > 1 && !/^\d+$/.test(content)) {
                        allFeedback.push({
                            type: 'diagnosis',
                            typeName: 'è¯Šæ–­è¾“å…¥',
                            typeColor: 'green',
                            content: content.trim(),
                            km: r.km || 'æœªçŸ¥ç§‘ç›®',
                            time: new Date(r.time),
                            userId: r.user_id,
                            isVip: r.is_vip
                        });
                    }
                });

            // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            allFeedback.sort((a, b) => b.time - a.time);

            // ç»Ÿè®¡å„ç±»å‹æ•°é‡
            const deptCount = allFeedback.filter(f => f.type === 'department').length;
            const questionCount = allFeedback.filter(f => f.type === 'question').length;
            const diagnosisCount = allFeedback.filter(f => f.type === 'diagnosis').length;
            const clickCount = rawData.filter(r => r.element === 'æ— ç§‘å®¤åé¦ˆ').length;

            // æ›´æ–°åé¦ˆæ•°é‡å¾½ç« 
            document.getElementById('feedback-count').textContent = allFeedback.length;

            // æ¸²æŸ“åé¦ˆåˆ—è¡¨
            const listContainer = document.getElementById('feedback-list');

            if (allFeedback.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-6 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p class="text-sm">æš‚æ— ç”¨æˆ·åé¦ˆ</p>
                    </div>
                `;
                return;
            }

            // é¢œè‰²æ˜ å°„
            const colorMap = {
                orange: { bg: 'bg-orange-100', text: 'text-orange-700', border: 'border-orange-200' },
                blue: { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-200' },
                green: { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-200' }
            };

            let html = `
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div class="flex flex-wrap items-center gap-3 text-sm">
                        <span class="text-gray-600">å…± <strong>${allFeedback.length}</strong> æ¡åé¦ˆ</span>
                        <span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs">ç§‘å®¤éœ€æ±‚ ${deptCount}</span>
                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs">é—®è¯Šè¾“å…¥ ${questionCount}</span>
                        <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs">è¯Šæ–­è¾“å…¥ ${diagnosisCount}</span>
                    </div>
                </div>
                <div class="space-y-3 max-h-96 overflow-y-auto">
            `;

            allFeedback.forEach((feedback) => {
                const timeStr = feedback.time.toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const vipBadge = feedback.isVip ?
                    '<span class="ml-2 px-1.5 py-0.5 text-xs bg-yellow-100 text-yellow-700 rounded">VIP</span>' : '';
                const colors = colorMap[feedback.typeColor];

                html += `
                    <div class="p-4 bg-white rounded-lg border border-gray-100 hover:${colors.border} transition-colors shadow-sm">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center flex-wrap gap-2 mb-1">
                                    <span class="px-2 py-0.5 text-xs ${colors.bg} ${colors.text} rounded">${feedback.typeName}</span>
                                    ${vipBadge}
                                </div>
                                <p class="text-gray-800 font-medium break-words">${feedback.content}</p>
                                <p class="text-xs text-gray-400 mt-1">æ¥æº: ${feedback.km}</p>
                            </div>
                            <span class="text-xs text-gray-400 whitespace-nowrap">${timeStr}</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            listContainer.innerHTML = html;
        }

        // ==================== äº‹ä»¶ç›‘å¬ ====================

        // åˆ·æ–°æŒ‰é’®
        document.getElementById('refresh-btn').addEventListener('click', () => {
            loadData();
        });

        // åº”ç”¨ç­›é€‰æŒ‰é’®
        document.getElementById('apply-filter-btn').addEventListener('click', () => {
            const dateRangePicker = document.getElementById('date-range-picker')._flatpickr;
            const selectedDates = dateRangePicker.selectedDates;

            if (selectedDates.length === 2) {
                const startDate = selectedDates[0];
                const endDate = selectedDates[1];

                applyDefaultFilter(startDate, endDate);
            } else {
                alert('è¯·é€‰æ‹©å®Œæ•´çš„æ—¥æœŸèŒƒå›´');
            }
        });

        // é‡ç½®ç­›é€‰æŒ‰é’®
        document.getElementById('reset-filter-btn').addEventListener('click', () => {
            const yesterday = getYesterday();
            const sevenDaysAgo = getDaysAgo(8);
            applyDefaultFilter(sevenDaysAgo, yesterday);
        });

        // å¿«æ·æ—¥æœŸé€‰æ‹©
        document.getElementById('quick-date-select').addEventListener('change', (e) => {
            const days = parseInt(e.target.value);
            const yesterday = getYesterday();
            const startDate = getDaysAgo(days + 1);

            const dateRangePicker = document.getElementById('date-range-picker')._flatpickr;
            dateRangePicker.setDate([startDate, yesterday]);

            applyDefaultFilter(startDate, yesterday);
        });

        // ç”¨æˆ·ç±»å‹ç­›é€‰
        document.getElementById('user-type-filter').addEventListener('change', (e) => {
            // è¿™é‡Œå¯ä»¥æ·»åŠ ç”¨æˆ·ç±»å‹ç­›é€‰é€»è¾‘
            console.log('ç”¨æˆ·ç±»å‹ç­›é€‰:', e.target.value);
        });

        // å¯¼å‡ºæŒ‰é’®å’Œèœå•æ§åˆ¶
        document.getElementById('export-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('hidden');
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å¯¼å‡ºèœå•
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('export-menu');
            const btn = document.getElementById('export-btn');
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // å“åº”å¼å¤„ç†
        window.addEventListener('resize', () => {
            Object.values(chartInstances).forEach(chart => {
                if (chart) {
                    chart.resize();
                }
            });
        });

        // ==================== æ•°æ®å¯¼å‡ºåŠŸèƒ½ ====================

        // å¯¼å‡ºæ•°æ®å‡½æ•°
        function exportData(format) {
            // å…³é—­èœå•
            document.getElementById('export-menu').classList.add('hidden');

            if (!currentData || currentData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }

            const timeRange = document.getElementById('data-time-range').textContent;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `AIç—…ä¾‹ç ”ä¹ å¹³å°æ•°æ®_${timestamp}`;

            // å‡†å¤‡å¯¼å‡ºæ•°æ®ï¼ˆæ¸…æ´—åçš„currentDataï¼‰
            const exportableData = currentData.map(item => ({
                ç”¨æˆ·ID: item.user_id || '',
                æ¨¡å—: item.module || '',
                åŠ¨ä½œç±»å‹: item.action_type || '',
                äº‹ä»¶å…ƒç´ : item.element || item.view || '',
                çŠ¶æ€: item.status || '',
                è¯•ç”¨æ ‡è¯†: item.trial || '',
                æ—¥æœŸ: item.date || new Date(parseInt(item.time)).toLocaleDateString('zh-CN'),
                æ—¶é—´: item.time_str || new Date(parseInt(item.time)).toLocaleTimeString('zh-CN')
            }));

            switch (format) {
                case 'csv':
                    exportToCSV(exportableData, filename);
                    break;
                case 'json':
                    exportToJSON(currentData, filename);
                    break;
                case 'excel':
                    exportToExcel(exportableData, filename);
                    break;
            }
        }

        // å¯¼å‡ºä¸ºCSV
        function exportToCSV(data, filename) {
            if (data.length === 0) return;

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row =>
                    headers.map(header => {
                        const value = row[header] || '';
                        // å¤„ç†åŒ…å«é€—å·æˆ–æ¢è¡Œçš„å­—æ®µ
                        return `"${String(value).replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');

            // æ·»åŠ BOMä»¥æ”¯æŒExcelæ­£ç¡®æ‰“å¼€ä¸­æ–‡
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadFile(blob, `${filename}.csv`);
        }

        // å¯¼å‡ºä¸ºJSON
        function exportToJSON(data, filename) {
            const jsonContent = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            downloadFile(blob, `${filename}.json`);
        }

        // å¯¼å‡ºä¸ºExcelï¼ˆä½¿ç”¨HTMLè¡¨æ ¼æ–¹å¼ï¼‰
        function exportToExcel(data, filename) {
            if (data.length === 0) return;

            const headers = Object.keys(data[0]);
            let excelContent = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>æ•°æ®</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta charset="UTF-8"></head><body><table>';

            // è¡¨å¤´
            excelContent += '<tr>' + headers.map(h => `<th style="background-color: #4472C4; color: white; font-weight: bold; border: 1px solid #ccc; padding: 8px;">${h}</th>`).join('') + '</tr>';

            // æ•°æ®è¡Œ
            data.forEach(row => {
                excelContent += '<tr>' + headers.map(h => `<td style="border: 1px solid #ccc; padding: 8px;">${row[h] || ''}</td>`).join('') + '</tr>';
            });

            excelContent += '</table></body></html>';

            const blob = new Blob(['\ufeff' + excelContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
            downloadFile(blob, `${filename}.xls`);
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            alert(`å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶åï¼š${filename}`);
        }

        // ==================== AI èŠå¤©åŠ©æ‰‹ ====================

        // ä¾›åº”å•†é…ç½®
        const PROVIDER_CONFIGS = {
            cloudflare: {
                name: 'Cloudflare Worker',
                endpoint: 'https://ai-dashboard-proxy.vee5208.workers.dev',
                requiresKey: false,
                models: [
                    { value: 'Qwen/Qwen2.5-7B-Instruct', label: 'Qwen2.5-7Bï¼ˆé»˜è®¤-å¿«é€Ÿï¼‰', desc: 'å‡è¡¡é€Ÿåº¦å’Œè´¨é‡ï¼Œé€‚åˆæ—¥å¸¸æŸ¥è¯¢' },
                    { value: 'Qwen/Qwen2.5-72B-Instruct', label: 'Qwen2.5-72Bï¼ˆå¼ºå¤§-å‡†ç¡®ï¼‰', desc: 'æ›´å¼ºå¤§çš„æ¨ç†èƒ½åŠ›ï¼Œé€‚åˆå¤æ‚åˆ†æ' },
                    { value: 'deepseek-ai/DeepSeek-V3', label: 'DeepSeek-V3ï¼ˆæœ€å¼º-æ¨ç†ï¼‰', desc: 'é¡¶çº§æ¨ç†èƒ½åŠ›ï¼Œé€‚åˆæ·±åº¦åˆ†æ' },
                    { value: 'THUDM/glm-4-9b-chat', label: 'GLM-4-9Bï¼ˆä¸­æ–‡ä¼˜åŒ–ï¼‰', desc: 'ä¸­æ–‡ç†è§£ä¼˜ç§€ï¼Œé€‚åˆæœ¬åœŸåŒ–åœºæ™¯' },
                    { value: 'meta-llama/Llama-3.3-70B-Instruct', label: 'Llama-3.3-70Bï¼ˆé€šç”¨ï¼‰', desc: 'é€šç”¨èƒ½åŠ›å¼ºï¼Œé€‚åˆå¤šæ ·åŒ–ä»»åŠ¡' },
                    { value: 'alibaba/Qwen2.5-Coder-7B-Instruct', label: 'Qwen2.5-Coder-7Bï¼ˆä»£ç ï¼‰', desc: 'ä»£ç ç†è§£ä¼˜ç§€ï¼Œé€‚åˆæŠ€æœ¯é—®é¢˜' }
                ]
            },
            deepseek: {
                name: 'DeepSeek',
                endpoint: 'https://api.deepseek.com/v1/chat/completions',
                requiresKey: true,
                models: [
                    { value: 'deepseek-chat', label: 'DeepSeek Chat', desc: 'é€šç”¨å¯¹è¯æ¨¡å‹' },
                    { value: 'deepseek-reasoner', label: 'DeepSeek Reasoner', desc: 'æ¨ç†å¢å¼ºæ¨¡å‹' }
                ]
            },
            kimi: {
                name: 'Kimi (æœˆä¹‹æš—é¢)',
                endpoint: 'https://api.moonshot.cn/v1/chat/completions',
                requiresKey: true,
                models: [
                    { value: 'moonshot-v1-8k', label: 'Moonshot V1 8K', desc: '8K ä¸Šä¸‹æ–‡çª—å£' },
                    { value: 'moonshot-v1-32k', label: 'Moonshot V1 32K', desc: '32K ä¸Šä¸‹æ–‡çª—å£' },
                    { value: 'moonshot-v1-128k', label: 'Moonshot V1 128K', desc: '128K ä¸Šä¸‹æ–‡çª—å£' }
                ]
            },
            alibaba: {
                name: 'é˜¿é‡Œç™¾ç‚¼',
                endpoint: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
                requiresKey: true,
                models: [
                    { value: 'qwen-plus', label: 'Qwen Plus', desc: 'é€šç”¨å¯¹è¯æ¨¡å‹' },
                    { value: 'qwen-turbo', label: 'Qwen Turbo', desc: 'å¿«é€Ÿå“åº”æ¨¡å‹' },
                    { value: 'qwen-max', label: 'Qwen Max', desc: 'æœ€å¼ºæ€§èƒ½æ¨¡å‹' }
                ]
            },
            siliconflow: {
                name: 'ç¡…åŸºæµåŠ¨',
                endpoint: 'https://api.siliconflow.cn/v1/chat/completions',
                requiresKey: true,
                models: [
                    { value: 'Qwen/Qwen2.5-7B-Instruct', label: 'Qwen2.5-7B', desc: 'å¿«é€Ÿå“åº”' },
                    { value: 'Qwen/Qwen2.5-72B-Instruct', label: 'Qwen2.5-72B', desc: 'å¼ºå¤§æ€§èƒ½' },
                    { value: 'deepseek-ai/DeepSeek-V3', label: 'DeepSeek-V3', desc: 'é¡¶çº§æ¨ç†' }
                ]
            },
            custom: {
                name: 'è‡ªå®šä¹‰ç«¯ç‚¹',
                endpoint: '',
                requiresKey: true,
                models: [
                    { value: 'custom-model', label: 'è‡ªå®šä¹‰æ¨¡å‹', desc: 'è¯·åœ¨ç«¯ç‚¹é…ç½®ä¸­æŒ‡å®š' }
                ]
            }
        };

        // ä½¿ç”¨ Cloudflare Worker ä»£ç†ï¼ˆAPI Key å®‰å…¨å­˜å‚¨åœ¨ Worker ç¯å¢ƒå˜é‡ä¸­ï¼‰
        const AI_PROXY_URL = 'https://ai-dashboard-proxy.vee5208.workers.dev';

        let chatHistory = [];
        let currentProvider = 'cloudflare';

        // æ¨¡å‹æè¿°æ˜ å°„
        const MODEL_DESCRIPTIONS = {
            'Qwen/Qwen2.5-7B-Instruct': 'å‡è¡¡é€Ÿåº¦å’Œè´¨é‡ï¼Œé€‚åˆæ—¥å¸¸æŸ¥è¯¢',
            'Qwen/Qwen2.5-72B-Instruct': 'æ›´å¼ºå¤§çš„æ¨ç†èƒ½åŠ›ï¼Œé€‚åˆå¤æ‚åˆ†æ',
            'deepseek-ai/DeepSeek-V3': 'é¡¶çº§æ¨ç†èƒ½åŠ›ï¼Œé€‚åˆæ·±åº¦åˆ†æ',
            'THUDM/glm-4-9b-chat': 'ä¸­æ–‡ç†è§£ä¼˜ç§€ï¼Œé€‚åˆæœ¬åœŸåŒ–åœºæ™¯',
            'meta-llama/Llama-3.3-70B-Instruct': 'é€šç”¨èƒ½åŠ›å¼ºï¼Œé€‚åˆå¤šæ ·åŒ–ä»»åŠ¡',
            'alibaba/Qwen2.5-Coder-7B-Instruct': 'ä»£ç ç†è§£ä¼˜ç§€ï¼Œé€‚åˆæŠ€æœ¯é—®é¢˜'
        };

        // æ›´æ–°ä¾›åº”å•†é…ç½®
        function updateProviderConfig() {
            const providerSelect = document.getElementById('ai-provider-select');
            const provider = providerSelect.value;
            currentProvider = provider;

            const config = PROVIDER_CONFIGS[provider];
            const customConfig = document.getElementById('custom-endpoint-config');
            const modelSelect = document.getElementById('ai-model-select');

            // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰ç«¯ç‚¹é…ç½®
            if (provider === 'custom') {
                customConfig.classList.remove('hidden');
            } else {
                customConfig.classList.add('hidden');
            }

            // æ›´æ–°æ¨¡å‹åˆ—è¡¨
            modelSelect.innerHTML = '';
            config.models.forEach((model, index) => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                if (index === 0) option.selected = true;
                modelSelect.appendChild(option);
            });

            // æ›´æ–°æ¨¡å‹æè¿°
            updateModelDisplay();

            // æç¤ºç”¨æˆ·é…ç½® API Keyï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (config.requiresKey && provider !== 'custom') {
                const apiKeyPrompt = prompt(`è¯·è¾“å…¥ ${config.name} çš„ API Keyï¼ˆå°†ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ï¼‰ï¼š`);
                if (apiKeyPrompt) {
                    localStorage.setItem(`ai_api_key_${provider}`, apiKeyPrompt);
                }
            }
        }

        // è·å–å½“å‰é€‰ä¸­çš„æ¨¡å‹
        function getCurrentModel() {
            const select = document.getElementById('ai-model-select');
            return select ? select.value : 'Qwen/Qwen2.5-7B-Instruct';
        }

        // æ›´æ–°æ¨¡å‹æè¿°
        function updateModelDisplay() {
            const provider = currentProvider;
            const config = PROVIDER_CONFIGS[provider];
            const modelValue = getCurrentModel();

            const model = config.models.find(m => m.value === modelValue);
            const description = model ? model.desc : MODEL_DESCRIPTIONS[modelValue] || 'é«˜è´¨é‡AIæ¨¡å‹';

            const descElement = document.getElementById('model-description');
            if (descElement) {
                descElement.textContent = description;
            }
        }

        // åˆ‡æ¢èŠå¤©çª—å£
        function toggleChat() {
            const container = document.getElementById('ai-chat-container');
            const btn = document.getElementById('ai-chat-btn');

            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                btn.classList.add('hidden');
            } else {
                container.classList.add('hidden');
                btn.classList.remove('hidden');
            }
        }

        // è·å–å½“å‰æ•°æ®ä¸Šä¸‹æ–‡
        function getCurrentDataContext() {
            const metrics = calculateMetrics(currentData);
            const cumulativeUsers = calculateCumulativeUsers();
            const retentionRate = calculateRetention(currentData, lastWeekData);

            // è®¡ç®—ç§‘å®¤åˆ†å¸ƒ
            const hasChineseElement = currentData.some(r => r.element && /[\u4e00-\u9fa5]/.test(r.element));
            const deptMap = {};
            currentData.forEach(row => {
                if (hasChineseElement && row.element && row.element.includes('ç§‘å®¤é€‰æ‹©:')) {
                    const dept = row.element.replace('ç§‘å®¤é€‰æ‹©:', '');
                    deptMap[dept] = (deptMap[dept] || 0) + 1;
                }
            });
            const topDepts = Object.entries(deptMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, count]) => `${name}(${count}æ¬¡)`);

            // è·å–æ—¶é—´èŒƒå›´
            const timeRange = document.getElementById('data-time-range').textContent;

            return {
                timeRange,
                totalUsers: metrics.totalUsers,
                enterChatUsers: metrics.enterChatUsers,
                enterRate: metrics.enterRate,
                diagnosisRate: metrics.diagnosisRate,
                completeRate: metrics.completeRate,
                firstTimeUsers: metrics.firstTimeUsers,
                returningUsers: metrics.returningUsers,
                retentionRate,
                cumulativeUsers,
                topDepartments: topDepts.join('ã€'),
                dataCount: currentData.length
            };
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(content, isUser = false) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-2';

            if (isUser) {
                messageDiv.classList.add('flex-row-reverse', 'space-x-reverse');
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white text-sm font-semibold flex-shrink-0">ä½ </div>
                    <div class="bg-blue-500 text-white rounded-lg p-3 shadow-sm max-w-[80%]">
                        <p class="text-sm">${content}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-sm font-semibold flex-shrink-0">AI</div>
                    <div class="bg-white rounded-lg p-3 shadow-sm max-w-[80%]">
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${content}</p>
                    </div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // è°ƒç”¨ AI APIï¼ˆæ”¯æŒå¤šä¾›åº”å•†ï¼‰
        async function callAIAPI(userMessage, dataContext) {
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ•°æ®åˆ†æåŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©ç”¨æˆ·ç†è§£å’Œåˆ†æ AIç—…ä¾‹ç ”ä¹ å¹³å°çš„æ•°æ®ã€‚

å½“å‰æ•°æ®æ¦‚è§ˆï¼ˆ${dataContext.timeRange}ï¼‰ï¼š
- æ´»è·ƒç”¨æˆ·æ•°ï¼š${dataContext.totalUsers}äºº
- è¿›å…¥é—®è¯Šç”¨æˆ·ï¼š${dataContext.enterChatUsers}äºº
- è¿›å…¥é—®è¯Šç‡ï¼š${dataContext.enterRate}%
- æ´»è·ƒç‡ï¼š${dataContext.diagnosisRate}%
- å®Œæˆç‡ï¼š${dataContext.completeRate}%
- æ–°ç”¨æˆ·æ•°ï¼š${dataContext.firstTimeUsers}äºº
- å›è®¿ç”¨æˆ·æ•°ï¼š${dataContext.returningUsers}äºº
- æ¬¡æ—¥ç•™å­˜ç‡ï¼š${dataContext.retentionRate}%
- å¹³å°ç´¯è®¡ç”¨æˆ·ï¼š${dataContext.cumulativeUsers}äºº
- çƒ­é—¨ç§‘å®¤ï¼š${dataContext.topDepartments}
- æ•°æ®è®°å½•æ•°ï¼š${dataContext.dataCount}æ¡

è¯·åŸºäºä»¥ä¸Šæ•°æ®å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œç”¨ç®€æ´ã€ä¸“ä¸šçš„è¯­è¨€ã€‚å¦‚æœç”¨æˆ·é—®é¢˜æ¶‰åŠå…·ä½“æ•°å­—ï¼Œè¯·ä»ä¸Šè¿°æ•°æ®ä¸­æå–ã€‚å¦‚æœéœ€è¦è®¡ç®—ï¼Œè¯·è¿›è¡Œåˆç†è®¡ç®—ã€‚ä¿æŒå›ç­”ç®€çŸ­ï¼ˆ3-5å¥è¯ï¼‰ã€‚`;

            chatHistory.push({ role: 'user', content: userMessage });

            const messages = [
                { role: 'system', content: systemPrompt },
                ...chatHistory.slice(-10) // ä¿ç•™æœ€è¿‘10è½®å¯¹è¯
            ];

            try {
                const currentModel = getCurrentModel();
                const config = PROVIDER_CONFIGS[currentProvider];

                // è·å–ç«¯ç‚¹å’Œ API Key
                let endpoint = config.endpoint;
                let apiKey = null;

                if (currentProvider === 'custom') {
                    endpoint = document.getElementById('custom-endpoint-url').value;
                    apiKey = document.getElementById('custom-api-key').value;
                    if (!endpoint) {
                        throw new Error('è¯·å…ˆé…ç½®è‡ªå®šä¹‰ç«¯ç‚¹');
                    }
                } else if (config.requiresKey) {
                    apiKey = localStorage.getItem(`ai_api_key_${currentProvider}`);
                    if (!apiKey) {
                        throw new Error(`è¯·å…ˆé…ç½® ${config.name} çš„ API Key`);
                    }
                }

                // æ„å»ºè¯·æ±‚å¤´
                const headers = {
                    'Content-Type': 'application/json'
                };

                // å¯¹äºéœ€è¦ API Key çš„ä¾›åº”å•†ï¼Œæ·»åŠ  Authorization å¤´
                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        model: currentModel,
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 500,
                        stream: false
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`AIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.message || errorData.error || response.statusText}`);
                }

                const data = await response.json();
                const aiMessage = data.choices[0].message.content;
                chatHistory.push({ role: 'assistant', content: aiMessage });

                return aiMessage;
            } catch (error) {
                console.error('AI APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // å…¼å®¹æ—§å‡½æ•°å
        const callSiliconFlowAPI = callAIAPI;

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, true);
            input.value = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loading = document.getElementById('chat-loading');
            loading.classList.remove('hidden');

            try {
                // è·å–å½“å‰æ•°æ®ä¸Šä¸‹æ–‡
                const dataContext = getCurrentDataContext();

                // è°ƒç”¨ AI API
                const aiResponse = await callSiliconFlowAPI(message, dataContext);

                // æ·»åŠ  AI å›å¤
                addMessage(aiResponse, false);
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
                addMessage('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ã€‚è¯·é‡è¯•ã€‚', false);
            } finally {
                loading.classList.add('hidden');
            }
        }

        // ==================== é¡µé¢åŠ è½½ ====================

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ•°æ®
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
        });

    </script>
</body>

</html>